{% extends 'base.html' %}

{% block title %}
    orders
{% endblock title %}

{% block body %}
<div class="container mt-5">
    <h2 class="text-center text-info mb-5" style="font-family: 'Poppins', sans-serif; font-weight: bold;">Your Orders</h2>

    {% for order in orders %}
        <div class="order-item mb-4 p-4 border rounded-lg shadow-lg" style="background-color: #ffffff; border-left: 6px solid #3498db; transition: all 0.3s ease;">
            <h5 class="text-dark" style="font-family: 'Arial', sans-serif; font-weight: 600; font-size: 1.2rem; margin-bottom: 10px;">{{ order.product.name }}</h5>
            <p><strong class="text-primary">Order Date:</strong> <span class="text-muted">{{ order.order_date }}</span></p>
            <p><strong class="text-primary">Status:</strong> 
                {% if order.is_paid %}
                    <span class="badge badge-success">Paid</span>
                {% else %}
                    <span class="badge badge-warning">Pending</span>
                {% endif %}
            </p>

            {% if not order.is_paid %}
                <form method="POST" action="{% url 'process_payment' order.id %}" class="mb-3">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-sm" style="border-radius: 25px; padding: 10px 20px; background-color: #28a745; border: none; font-size: 14px;">Make Payment</button>
                </form>
            {% endif %}

            <!-- Buttons Layout with spacing -->
            <div class="d-flex justify-content-between mt-3">
                <form action="{% url 'delete_order' order.id %}" method="post" style="display: inline;" id="deleteForm{{ order.id }}">
                    {% csrf_token %}
                    <button type="submit" class="btn-delete btn btn-danger btn-sm" id="deleteBtn{{ order.id }}" style="display: block; border-radius: 25px; padding: 10px 20px; background-color: #e74c3c; border: none; font-size: 14px;">
                        Delete Order
                    </button>
                </form>

                <p class="timer mt-3 mb-0" id="timer{{ order.id }}" style="font-weight: bold; color: #e74c3c; font-size: 14px;">Time left to delete: 1:00:00</p>
            </div>
        </div>
    {% endfor %}
</div>

<script>
    // Timer Logic - Starts as soon as the order is placed
    function startTimer(orderId, orderDate) {
        const orderTime = new Date(orderDate).getTime();  // Order creation time in milliseconds
        const oneHourInMillis = 3600 * 1000;  // 1 hour in milliseconds
        const deleteDeadline = orderTime + oneHourInMillis;  // Calculate the delete deadline time

        const timerDisplay = document.getElementById('timer' + orderId);
        const deleteForm = document.getElementById('deleteForm' + orderId);

        const countdown = setInterval(() => {
            const currentTime = new Date().getTime();  // Current time in milliseconds
            let timeLeft = deleteDeadline - currentTime;  // Calculate remaining time

            if (timeLeft <= 0) {
                clearInterval(countdown);
                deleteForm.style.display = 'none';
                timerDisplay.textContent = 'Delete option has expired.';
                return;
            }

            // Calculate hours, minutes, and seconds from remaining time
            let hours = Math.floor(timeLeft / 3600000);  // hours
            let minutes = Math.floor((timeLeft % 3600000) / 60000);  // minutes
            let seconds = Math.floor((timeLeft % 60000) / 1000);  // seconds

            // Update the timer display
            timerDisplay.textContent = `Time left to delete: ${hours}:${minutes}:${seconds}`;
        }, 1000);
    }

    // Initialize the timer when the page loads for each order
    document.addEventListener('DOMContentLoaded', function() {
        {% for order in orders %}
            startTimer({{ order.id }}, "{{ order.order_date }}");
        {% endfor %}
    });
</script>
{% endblock body %}
